<!--
  Featured Products Slider section
  - Two tabs: New Arrivals & Best Sellers (select collections in theme editor)
  - Responsive, infinite-loop slider with arrows and touch swipe
  - Include this section on your homepage via Theme Customizer (Add section -> Featured Products Slider)
  - To avoid duplicates, remove other "Featured products" sections from your homepage template in the Theme Customizer
-->

{% assign section_id = section.id %}

<section id="featured-products-slider-{{ section_id }}" class="featured-products-slider">
  <div class="fps-inner">
    <div class="fps-header">
      <div class="fps-title">{{ section.settings.heading }}</div>
      <div class="fps-subtext">{{ section.settings.subtext }}</div>
      <div class="fps-tabs" role="tablist" aria-label="Featured product tabs">
        <button class="fps-tab fps-tab--active" data-target="new" role="tab" aria-selected="true">New Arrivals</button>
        <button class="fps-tab" data-target="best" role="tab" aria-selected="false">Best Sellers</button>
      </div>
    </div>

    <div class="fps-controls">
      <button class="fps-arrow fps-prev" aria-label="Previous products">‹</button>
      <button class="fps-arrow fps-next" aria-label="Next products">›</button>
    </div>

    <div class="fps-content">
      <!-- New Arrivals slider -->
      <div class="fps-slider fps-slider--active" data-type="new">
        <div class="fps-track">
          {% if section.settings.new_collection and section.settings.new_collection.products.size > 0 %}
            {% assign new_products = section.settings.new_collection.products | slice: 0, section.settings.product_limit %}
            {% for product in new_products %}
              <div class="fps-item">
                <a href="{{ product.url }}" class="fps-card">
                  <div class="fps-image-wrap">
                    {% if product.featured_image %}
                      <img src="{{ product.featured_image | img_url: '600x600' }}" alt="{{ product.title }}" loading="lazy" />
                    {% else %}
                      <div class="fps-image-placeholder"></div>
                    {% endif %}
                  </div>
                  <div class="fps-card-body">
                    <div class="fps-category">{{ product.type | default: 'Product' }}</div>
                    <div class="fps-name">{{ product.title }}</div>
                    <div class="fps-price">
                      {% if product.price_varies %}
                        {% assign min_price = product.price_min | money %}
                        From {{ min_price }}
                      {% else %}
                        {% assign price = product.price | money %}
                        {{ price }}
                      {% endif %}
                      {% if product.compare_at_price_max > product.price_max %}
                        <span class="fps-compare">{{ product.compare_at_price_max | money }}</span>
                      {% endif %}
                    </div>
                  </div>
                </a>
              </div>
            {% endfor %}
          {% else %}
            <div class="fps-empty">No products found in the selected collection.</div>
          {% endif %}
        </div>
      </div>

      <!-- Best Sellers slider -->
      <div class="fps-slider" data-type="best" aria-hidden="true">
        <div class="fps-track">
          {% if section.settings.best_collection and section.settings.best_collection.products.size > 0 %}
            {% assign best_products = section.settings.best_collection.products | slice: 0, section.settings.product_limit %}
            {% for product in best_products %}
              <div class="fps-item">
                <a href="{{ product.url }}" class="fps-card">
                  <div class="fps-image-wrap">
                    {% if product.featured_image %}
                      <img src="{{ product.featured_image | img_url: '600x600' }}" alt="{{ product.title }}" loading="lazy" />
                    {% else %}
                      <div class="fps-image-placeholder"></div>
                    {% endif %}
                  </div>
                  <div class="fps-card-body">
                    <div class="fps-category">{{ product.type | default: 'Product' }}</div>
                    <div class="fps-name">{{ product.title }}</div>
                    <div class="fps-price">
                      {% if product.price_varies %}
                        {% assign min_price = product.price_min | money %}
                        From {{ min_price }}
                      {% else %}
                        {% assign price = product.price | money %}
                        {{ price }}
                      {% endif %}
                      {% if product.compare_at_price_max > product.price_max %}
                        <span class="fps-compare">{{ product.compare_at_price_max | money }}</span>
                      {% endif %}
                    </div>
                  </div>
                </a>
              </div>
            {% endfor %}
          {% else %}
            <div class="fps-empty">No products found in the selected collection.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <style>
    :root { --fps-green: #1ea64a; --fps-dark: #0b2f1b; }
    .featured-products-slider { padding: 36px 16px; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color: var(--fps-dark); }
    .featured-products-slider .fps-inner { max-width: 1300px; margin: 0 auto; position: relative; }
    .fps-header { margin-bottom: 18px; }
    .fps-title { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
    .fps-subtext { color: #6b6b6b; font-size: 14px; margin-bottom: 12px; }
    .fps-tabs { display: inline-flex; gap: 12px; margin-bottom: 12px; }
    .fps-tab { background: transparent; border: none; padding: 6px 0; font-weight:600; cursor: pointer; color: var(--fps-dark); position: relative; }
    .fps-tab--active { color: var(--fps-green); }
    .fps-tab--active::after { content: ''; position: absolute; left: 0; right: 0; bottom: -6px; height: 3px; background: var(--fps-green); border-radius: 2px; }

    .fps-controls { position: absolute; right: 12px; top: 12px; display:flex; gap:8px; }
    .fps-arrow { background:#fff; border:1px solid #e6e6e6; width:40px; height:40px; border-radius:20px; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; }

    .fps-content { overflow: hidden; position: relative; }
    .fps-slider { display: none; }
    .fps-slider--active { display: block; }
    .fps-track { display:flex; align-items:stretch; transition: transform 500ms cubic-bezier(.22,.9,.35,1); will-change: transform; }
    .fps-item { box-sizing: border-box; padding: 12px; }
    .fps-card { display:flex; flex-direction:column; text-decoration:none; color: inherit; }
    .fps-image-wrap { background:#fff; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; height:240px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); transition: transform 300ms ease; }
    .fps-image-wrap img { width:100%; height:100%; object-fit:contain; display:block; }
    .fps-card:hover .fps-image-wrap { transform: translateY(-6px); }
    .fps-card-body { padding-top:10px; }
    .fps-category { font-size:12px; color:#7a7a7a; margin-bottom:6px; }
    .fps-name { font-weight:700; font-size:14px; margin-bottom:6px; }
    .fps-price { font-weight:600; color: var(--fps-dark); }
    .fps-compare { text-decoration: line-through; color:#8b8b8b; margin-left:8px; font-weight:400; }

    .fps-empty{ padding:40px; text-align:center; color:#777 }

    /* Responsive widths managed by JS; fallback widths for no-JS */
    @media (min-width:1200px) { .fps-item { width: calc(100% / 6); } }
    @media (min-width:992px) and (max-width:1199px) { .fps-item { width: calc(100% / 4); } }
    @media (min-width:768px) and (max-width:991px) { .fps-item { width: calc(100% / 3); } }
    @media (min-width:480px) and (max-width:767px) { .fps-item { width: calc(100% / 2); } }
    @media (max-width:479px) { .fps-item { width:100%; } }
  </style>

  <script>
    (function(){
      var root = document.getElementById('featured-products-slider-{{ section_id }}');
      if (!root) return;

      // Helpers
      function $sel(sel, ctx){ return (ctx || document).querySelector(sel); }
      function $selAll(sel, ctx){ return Array.prototype.slice.call((ctx || document).querySelectorAll(sel)); }

      var tabs = $selAll('.fps-tab', root);
      var sliders = $selAll('.fps-slider', root);
      var prevBtn = $sel('.fps-prev', root);
      var nextBtn = $sel('.fps-next', root);

      // Slider state per slider element
      var instances = [];

      function computeItemsPerView(){
        var w = window.innerWidth;
        if (w >= 1200) return 6;
        if (w >= 992) return 4;
        if (w >= 768) return 3;
        if (w >= 480) return 2;
        return 1;
      }

      function initSlider(slider){
        var track = $sel('.fps-track', slider);
        var items = $selAll('.fps-item', slider);
        if (!track || items.length === 0) return null;

        var perView = computeItemsPerView();
        // remove existing clones (if re-init)
        $selAll('.fps-item[data-clone]', track).forEach(function(n){ n.parentNode.removeChild(n); });

        // set item flex-basis
        items.forEach(function(it){ it.style.flex = '0 0 ' + (100 / perView) + '%'; });

        var total = items.length;
        for (var i=0;i<perView && i<total;i++){
          var clone = items[i].cloneNode(true);
          clone.setAttribute('data-clone','after');
          track.appendChild(clone);
        }
        for (i=total-1;i>=0 && (total -1 - i) < perView;i--){
          var clone2 = items[i].cloneNode(true);
          clone2.setAttribute('data-clone','before');
          track.insertBefore(clone2, track.firstChild);
        }

        // recalc nodes
        var slides = $selAll('.fps-item', track);
        var index = perView; // start at first real slide

        function updatePos(animate){
          if (!animate) track.style.transition = 'none'; else track.style.transition = '';
          track.style.transform = 'translateX(' + (- (index * (100 / perView))) + '%)';
        }

        function next(){ if (isTransitioning) return; isTransitioning = true; index++; updatePos(true); }
        function prev(){ if (isTransitioning) return; isTransitioning = true; index--; updatePos(true); }

        var isTransitioning = false;
        track.addEventListener('transitionend', function(){
          if (index >= total + perView){ index = perView; updatePos(false); }
          if (index < perView){ index = total + (index); updatePos(false); }
          isTransitioning = false;
        });

        // touch support
        var startX = 0; var currentX = 0; var isDown = false; var moved = false;
        track.addEventListener('touchstart', function(e){ startX = e.touches[0].clientX; isDown = true; track.style.transition = 'none'; });
        track.addEventListener('touchmove', function(e){ if (!isDown) return; currentX = e.touches[0].clientX; var dx = currentX - startX; var pct = dx / root.querySelector('.fps-content').clientWidth * 100; track.style.transform = 'translateX(' + ( - (index * (100 / perView)) + pct ) + '%)'; moved = true; });
        track.addEventListener('touchend', function(e){ if (!isDown) return; isDown = false; if (!moved){ return; } var dx = currentX - startX; if (dx < -40) { next(); } else if (dx > 40) { prev(); } else { updatePos(true); } moved = false; });

        return { track: track, next: next, prev: prev, update: function(){ perView = computeItemsPerView(); items = $selAll('.fps-item', slider).filter(function(n){ return !n.hasAttribute('data-clone'); }); items.forEach(function(it){ it.style.flex = '0 0 ' + (100 / perView) + '%'; updatePos(false); } ) } };
      }

      // Initialize all sliders
      sliders.forEach(function(s){ var inst = initSlider(s); instances.push(inst); });

      // Arrows target the visible slider instance
      function visibleInstance(){ var active = $sel('.fps-slider--active', root); var idx = sliders.indexOf(active); return instances[idx]; }

      nextBtn.addEventListener('click', function(){ var inst = visibleInstance(); if (inst && inst.next) inst.next(); });
      prevBtn.addEventListener('click', function(){ var inst = visibleInstance(); if (inst && inst.prev) inst.prev(); });

      // Tab switching
      tabs.forEach(function(tab){ tab.addEventListener('click', function(){ var target = tab.getAttribute('data-target'); tabs.forEach(function(t){ t.classList.remove('fps-tab--active'); t.setAttribute('aria-selected','false'); }); tab.classList.add('fps-tab--active'); tab.setAttribute('aria-selected','true'); sliders.forEach(function(s){ if (s.getAttribute('data-type') === target){ s.classList.add('fps-slider--active'); s.setAttribute('aria-hidden','false'); } else { s.classList.remove('fps-slider--active'); s.setAttribute('aria-hidden','true'); } }); }); });

      // Re-init on resize to adjust per-view counts
      var resizeTimer; window.addEventListener('resize', function(){ clearTimeout(resizeTimer); resizeTimer = setTimeout(function(){ instances = []; sliders.forEach(function(s){ var newInst = initSlider(s); instances.push(newInst); }); }, 250); });

    })();
  </script>

  {% schema %}
  {
    "name": "Featured Products Slider",
    "settings": [
      {"type":"text","id":"heading","label":"Section heading","default":"Featured Products"},
      {"type":"textarea","id":"subtext","label":"Subtext","default":"Discover our newest launches and all-time bestsellers, curated just for you."},
      {"type":"collection","id":"new_collection","label":"Collection for New Arrivals"},
      {"type":"collection","id":"best_collection","label":"Collection for Best Sellers"},
      {"type":"number","id":"product_limit","label":"Product limit per tab","default":12}
    ],
    "presets": [{"name":"Featured Products Slider","category":"Products"}]
  }
  {% endschema %}

</section>
