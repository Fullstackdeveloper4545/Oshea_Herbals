{%- assign new_collection = collections[section.settings.collection_new] -%}
{%- assign best_collection = collections[section.settings.collection_best] -%}
{%- assign products_limit = section.settings.products_limit | default: 12 -%}
{%- assign new_count = new_collection.products_count | default: 0 | plus: 0 -%}
{%- assign best_count = best_collection.products_count | default: 0 | plus: 0 -%}
{%- assign placeholder_count = products_limit | default: 12 | plus: 0 -%}
{%- if placeholder_count < 4 -%}{%- assign placeholder_count = 4 -%}{%- endif -%}

<style>
  .fp-grid {
    padding: 36px 12px 48px;
    background: #fff;
  }
  .fp-grid__inner {
    max-width: 1400px;
    margin: 0 auto;
  }
  .fp-grid__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 20px;
    margin-bottom: 16px;
  }
  .fp-grid__title {
    margin: 0;
    font-size: 32px;
    font-weight: 800;
    color: #0b2f1b;
  }
  .fp-grid__sub {
    margin: 6px 0 0;
    color: #4d5b51;
    font-size: 16px;
  }
  .fp-grid__tabs {
    display: inline-flex;
    gap: 22px;
    font-size: 14px;
    font-weight: 700;
    color: #0b8c53;
    position: relative;
    z-index: 2;
  }
  .fp-grid__tab {
    cursor: pointer;
    position: relative;
    padding-bottom: 6px;
    transition: color 120ms ease;
  }
  .fp-grid__tab:hover {
    color: #059144;
  }
  .fp-grid__tab--active::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 2px;
    background: #0b8c53;
  }
  .fp-grid__viewport {
    position: relative;
    overflow: hidden;
  }
  .fp-grid__track {
    display: flex;
    gap: 24px;
    transition: transform 320ms ease;
    will-change: transform;
  }
  .fp-card {
    background: #fff;
    border-radius: 18px;
    border: 1px solid rgba(11, 8, 10, 0.1);
    overflow: hidden;
    box-shadow: 0 18px 35px rgba(0, 0, 0, 0.08);
    min-width: 280px;
    max-width: 320px;
    flex: 0 0 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .fp-card__media {
    width: 100%;
    aspect-ratio: 4 / 5;
    background: linear-gradient(180deg, #f5f5f5 0%, #e4e4e4 100%);
    position: relative;
    border-bottom: 1px solid rgba(11, 8, 10, 0.08);
  }
  .fp-card__media img.fp-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 14px;
  }
  .fp-card__media .placeholder-svg {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 14px;
  }
  .fp-card__media::after {
    content: "";
    position: absolute;
    inset: 20px;
    border: 1px dashed rgba(11, 8, 10, 0.2);
    border-radius: 12px;
  }
  .fp-card__badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: #0b8c53;
    color: #fff;
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.4px;
  }
  .fp-card__body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .fp-card__meta {
    color: #6a746f;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin: 0;
  }
  .fp-card__name {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #0b2f1b;
    line-height: 1.4;
  }
  .fp-card__price {
    margin: 0;
    font-size: 16px;
    font-weight: 800;
    color: #0b8c53;
  }
  .fp-grid__empty {
    padding: 8px 0 0;
    color: #4d5b51;
    font-size: 14px;
  }
  .fp-grid__controls {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 18px;
  }
  .fp-grid__arrow {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 1px solid #0b8c53;
    background: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #0b2f1b;
    font-size: 18px;
    transition: border-color 150ms ease, box-shadow 150ms ease, opacity 150ms ease, transform 150ms ease;
  }
  .fp-grid__arrow:hover:not([disabled]) {
    border-color: #059144;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }
  .fp-grid__arrow[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }
  @media (max-width: 1100px) {
    .fp-grid__track {
      gap: 20px;
    }
    .fp-card {
      min-width: 260px;
      flex: 0 0 280px;
    }
  }
  @media (max-width: 768px) {
    .fp-grid {
      padding: 28px 10px 36px;
    }
    .fp-grid__header {
      flex-direction: column;
      align-items: flex-start;
    }
    .fp-grid__tabs {
      margin-top: 12px;
    }
  }
  @media (max-width: 520px) {
    .fp-grid__track {
      gap: 16px;
    }
    .fp-card {
      min-width: 220px;
      flex: 0 0 240px;
    }
  }

.fp-grid__viewport[data-tab-panel="best"] .fp-card__badge {
  display: none;
}
</style>

<section class="fp-grid" id="featured-products-{{ section.id }}">
  <div class="fp-grid__inner">
    <div class="fp-grid__header">
      <div>
        <h2 class="fp-grid__title">{{ section.settings.heading }}</h2>
        {% if section.settings.subheading != blank %}
          <p class="fp-grid__sub">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
      <div class="fp-grid__tabs" role="tablist">
        <span class="fp-grid__tab fp-grid__tab--active" data-tab="new" role="tab" aria-selected="true">New Arrivals</span>
        <span class="fp-grid__tab" data-tab="best" role="tab" aria-selected="false">Best Sellers</span>
      </div>
    </div>

    <div class="fp-grid__viewport" data-tab-panel="new">
      <div class="fp-grid__track" data-track="new">
        {% if new_collection and new_count > 0 %}
          {% for product in new_collection.products limit: products_limit %}
            <article class="fp-card">
              <div class="fp-card__media">
                <span class="fp-card__badge">New</span>
                {% if product.featured_image %}
                  <img
                    class="fp-card__image"
                    src="{{ product.featured_image | image_url: width: 720 }}"
                    alt="{{ product.title | escape }}"
                    loading="lazy"
                    width="{{ product.featured_image.width }}"
                    height="{{ product.featured_image.height }}"
                  >
                {% elsif section.settings.fallback_image %}
                  {{ section.settings.fallback_image | image_url: width: 720 | image_tag: class: 'fp-card__image', loading: 'lazy' }}
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {% endif %}
              </div>
              <div class="fp-card__body">
                <p class="fp-card__meta">{{ product.type | default: product.vendor | default: 'Product' }}</p>
                <h3 class="fp-card__name">
                  <a class="link" href="{{ product.url }}">{{ product.title }}</a>
                </h3>
                <p class="fp-card__price">
                  {% if product.price_varies %}
                    {{ product.price_min | money }} - {{ product.price_max | money }}
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </p>
              </div>
            </article>
          {% endfor %}
        {% else %}
          {% for i in (1..placeholder_count) %}
            <article class="fp-card fp-card--placeholder">
              <div class="fp-card__media">
                <span class="fp-card__badge">New</span>
                {% if section.settings.fallback_image %}
                  {{ section.settings.fallback_image | image_url: width: 720 | image_tag: class: 'fp-card__image', loading: 'lazy' }}
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {% endif %}
              </div>
              <div class="fp-card__body">
                <p class="fp-card__meta">Add products</p>
                <h3 class="fp-card__name">Select a collection</h3>
                <p class="fp-card__price">They will appear here</p>
              </div>
            </article>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <div class="fp-grid__viewport" data-tab-panel="best" style="display: none;">
      <div class="fp-grid__track" data-track="best">
        {% if best_collection and best_count > 0 %}
          {% for product in best_collection.products limit: products_limit %}
            <article class="fp-card">
              <div class="fp-card__media">
                {% if product.featured_image %}
                  <img
                    class="fp-card__image"
                    src="{{ product.featured_image | image_url: width: 720 }}"
                    alt="{{ product.title | escape }}"
                    loading="lazy"
                    width="{{ product.featured_image.width }}"
                    height="{{ product.featured_image.height }}"
                  >
                {% elsif section.settings.fallback_image %}
                  {{ section.settings.fallback_image | image_url: width: 720 | image_tag: class: 'fp-card__image', loading: 'lazy' }}
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {% endif %}
              </div>
              <div class="fp-card__body">
                <p class="fp-card__meta">{{ product.type | default: product.vendor | default: 'Product' }}</p>
                <h3 class="fp-card__name">
                  <a class="link" href="{{ product.url }}">{{ product.title }}</a>
                </h3>
                <p class="fp-card__price">
                  {% if product.price_varies %}
                    {{ product.price_min | money }} - {{ product.price_max | money }}
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </p>
              </div>
            </article>
          {% endfor %}
        {% else %}
          {% for i in (1..placeholder_count) %}
            <article class="fp-card fp-card--placeholder">
              <div class="fp-card__media">
                <span class="fp-card__badge">New</span>
                {% if section.settings.fallback_image %}
                  {{ section.settings.fallback_image | image_url: width: 720 | image_tag: class: 'fp-card__image', loading: 'lazy' }}
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {% endif %}
              </div>
              <div class="fp-card__body">
                <p class="fp-card__meta">Add products</p>
                <h3 class="fp-card__name">Select a collection</h3>
                <p class="fp-card__price">They will appear here</p>
              </div>
            </article>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    {% if section.settings.show_arrows %}
      <div class="fp-grid__controls">
        <button class="fp-grid__arrow" type="button" data-dir="-1" aria-label="Previous">&#8592;</button>
        <button class="fp-grid__arrow" type="button" data-dir="1" aria-label="Next">&#8594;</button>
      </div>
    {% endif %}
  </div>
</section>

<script>
  (() => {
    const root = document.getElementById('featured-products-{{ section.id }}');
    if (!root) return;
    const tabs = root.querySelectorAll('.fp-grid__tab');
    const panels = root.querySelectorAll('[data-tab-panel]');
    const arrows = root.querySelectorAll('.fp-grid__arrow');
    let currentTab = 'new';
    let index = 0;

    const gap = 24;

    function track() {
      return root.querySelector(`[data-track="${currentTab}"]`);
    }
    function cards() {
      const t = track();
      return t ? Array.from(t.children) : [];
    }
    function perView() {
      const w = window.innerWidth;
      if (w >= 1400) return 5.6;
      if (w >= 1200) return 5;
      if (w >= 1000) return 4;
      if (w >= 768) return 3;
      if (w >= 560) return 2;
      return 1.2;
    }
    function clamp() {
      const c = cards();
      const max = Math.max(0, Math.ceil(c.length - perView()));
      index = Math.max(0, Math.min(index, max));
      return max;
    }
    function update() {
      const t = track();
      const c = cards();
      if (!t || c.length === 0) return;
      const cardWidth = c[0].getBoundingClientRect().width + gap;
      const max = clamp();
      if (arrows.length === 2) {
        arrows[0].disabled = index <= 0;
        arrows[1].disabled = index >= max;
      }
      t.style.transform = `translateX(${-index * cardWidth}px)`;
    }
    function switchTab(tab) {
      if (tab === currentTab) return;
      currentTab = tab;
      index = 0;
      tabs.forEach((el) => {
        const active = el.dataset.tab === tab;
        el.classList.toggle('fp-grid__tab--active', active);
        el.setAttribute('aria-selected', active);
      });
      panels.forEach((p) => {
        p.style.display = p.dataset.tabPanel === tab ? '' : 'none';
      });
      update();
    }
    tabs.forEach((tab) => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
    arrows.forEach((btn) =>
      btn.addEventListener('click', () => {
        index += btn.dataset.dir === '1' ? 1 : -1;
        update();
      })
    );
    window.addEventListener('resize', update);

    let startX = 0;
    let deltaX = 0;
    let isDown = false;
    root.addEventListener('touchstart', (e) => {
      const t = e.touches[0];
      startX = t.clientX;
      isDown = true;
      deltaX = 0;
    });
    root.addEventListener('touchmove', (e) => {
      if (!isDown) return;
      deltaX = e.touches[0].clientX - startX;
    });
    root.addEventListener('touchend', () => {
      if (!isDown) return;
      const threshold = 40;
      if (deltaX < -threshold) index += 1;
      if (deltaX > threshold) index -= 1;
      update();
      isDown = false;
    });

    update();
  })();
</script>

{% schema %}
{
  "name": "Featured products",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Featured Products" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Discover our newest launches and bestsellers." },
    { "type": "collection", "id": "collection_new", "label": "New arrivals collection" },
    { "type": "collection", "id": "collection_best", "label": "Best sellers collection" },
    { "type": "image_picker", "id": "fallback_image", "label": "Fallback image (shown when product has no image)" },
    { "type": "range", "id": "products_limit", "label": "Products to show", "min": 4, "max": 20, "step": 1, "default": 12 },
    { "type": "checkbox", "id": "show_arrows", "label": "Show arrows", "default": true }
  ],
  "presets": [
    { "name": "Featured products" }
  ]
}
{% endschema %}
